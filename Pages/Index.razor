@* ============================================================================
   Project:     SpaceInvaders
   File:        Index.razor
   Description: Main game page component with canvas rendering and input handling
   Author:      James Booth
   Created:     2024
   License:     MIT License - See LICENSE file in the project root
   Copyright:   (c) 2024-2026 James Booth
   ============================================================================ *@

@page "/"
@inject IJSRuntime JS
@inject HttpClient Http
@implements IAsyncDisposable
@using Microsoft.JSInterop

<div class="game-container" @onkeydown="OnKeyDown" @onkeyup="OnKeyUp" @onkeydown:preventDefault tabindex="0" @ref="_containerRef">
    @if (_isLoading)
    {
        <div class="loading">
            <!-- Space Invader Crab Icon -->
            <svg class="invader-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 11 8" width="256" height="186" shape-rendering="crispEdges">
                <rect fill="currentColor" x="2" y="0" width="1" height="1.1"/>
                <rect fill="currentColor" x="8" y="0" width="1" height="1.1"/>
                <rect fill="currentColor" x="3" y="1" width="1" height="1.1"/>
                <rect fill="currentColor" x="7" y="1" width="1" height="1.1"/>
                <rect fill="currentColor" x="2" y="2" width="7" height="1.1"/>
                <rect fill="currentColor" x="1" y="3" width="2" height="1.1"/>
                <rect fill="currentColor" x="4" y="3" width="3" height="1.1"/>
                <rect fill="currentColor" x="8" y="3" width="2" height="1.1"/>
                <rect fill="currentColor" x="0" y="4" width="11" height="1.1"/>
                <rect fill="currentColor" x="0" y="5" width="1" height="1.1"/>
                <rect fill="currentColor" x="2" y="5" width="7" height="1.1"/>
                <rect fill="currentColor" x="10" y="5" width="1" height="1.1"/>
                <rect fill="currentColor" x="0" y="6" width="1" height="1.1"/>
                <rect fill="currentColor" x="2" y="6" width="1" height="1.1"/>
                <rect fill="currentColor" x="8" y="6" width="1" height="1.1"/>
                <rect fill="currentColor" x="10" y="6" width="1" height="1.1"/>
                <rect fill="currentColor" x="3" y="7" width="2" height="1.1"/>
                <rect fill="currentColor" x="6" y="7" width="2" height="1.1"/>
            </svg>
            <h1>SPACE INVADERS</h1>
            <p>@_loadingMessage</p>
            
            @if (_missingRoms.Count > 0)
            {
                <div class="missing-files missing-error">
                    <h2>ROM FILES MISSING</h2>
                    <p>The following ROM files are required to run the emulator:</p>
                    <ul>
                        @foreach (var rom in _missingRoms)
                        {
                            <li>@rom</li>
                        }
                    </ul>
                </div>
            }
            
            @if (_missingSounds.Count > 0)
            {
                <div class="missing-files missing-warning">
                    <h2>SOUND FILES MISSING</h2>
                    <p>The following sound files were not found. The game will run without sound:</p>
                    <ul>
                        @foreach (var sound in _missingSounds)
                        {
                            <li>@sound</li>
                        }
                    </ul>
                    <button class="acknowledge-btn" @onclick="AcknowledgeSoundWarning">CONTINUE WITHOUT SOUND</button>
                </div>
            }
        </div>
    }
    
    @if (!_isLoading)
    {
        <div class="version-label">Space Invaders is © Taito Corporation.</div>
        <div class="version-label">This emulator is for educational purposes only.</div>
    }

    <div class="canvas-wrapper">
        <canvas id="gameCanvas" style="display: @(_isLoading ? "none" : "block")"></canvas>
    </div>
    
    @if (!_isLoading)
    {
        <div class="credit-hint">Press <span class="credit-key">C</span> to add credits and <span class="credit-key">1</span> or <span class="credit-key">2</span> players to start the game</div>
        <div class="controls-hint">Arrow keys <span class="credit-key"><span class="btn-text arrow-text">&larr;</span></span> <span class="credit-key"><span class="btn-text arrow-text">&rarr;</span></span> to move and <span class="credit-key">SPACE BAR</span> to fire</div>
    }
</div>

@code {
    private SpaceInvadersEmulator? _emulator;
    private PeriodicTimer? _gameLoop;
    private CancellationTokenSource? _cts;
    private bool _isLoading = true;
    private string _loadingMessage = "Loading...";
    private ElementReference _containerRef;
    private bool _hasInitialized;
    private DotNetObjectReference<Index>? _dotNetRef;
    private string _versionString = typeof(Index).Assembly.GetName().Version?.ToString(3) ?? "0.0";
    private List<string> _missingRoms = new();
    private List<string> _missingSounds = new();
    private TaskCompletionSource? _soundWarningAcknowledged;
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Wait for next render cycle to ensure canvas is in DOM
            await Task.Delay(50);
            await InitializeEmulatorAsync();
        }
    }
    
    private async Task InitializeEmulatorAsync()
    {
        if (_hasInitialized) return;
        _hasInitialized = true;
        
        try
        {
            _emulator = new SpaceInvadersEmulator(JS, Http);
            
            _loadingMessage = "Loading game...";
            StateHasChanged();
            
            var success = await _emulator.InitializeAsync();
            
            _missingRoms = _emulator.MissingRoms;
            _missingSounds = _emulator.MissingSounds;
            
            if (!success)
            {
                // ROMs are missing — stay on loading screen with error
                _loadingMessage = "Unable to start the emulator.";
                StateHasChanged();
                return;
            }
            
            if (_missingSounds.Count > 0)
            {
                // Wait for player to acknowledge the sound warning
                _loadingMessage = "";
                _soundWarningAcknowledged = new TaskCompletionSource();
                StateHasChanged();
                await _soundWarningAcknowledged.Task;
            }
            else
            {
                // Extra delay to show loading screen
                await Task.Delay(1000);
            }
            
            _isLoading = false;
            StateHasChanged();
            
            // Focus the container for keyboard input
            await Task.Delay(100);
            await _containerRef.FocusAsync();
            
            // Initialize touch controls (passes a reference so JS can call back into C#)
            _dotNetRef = DotNetObjectReference.Create(this);
            await JS.InvokeVoidAsync("gameInterop.initializeTouchControls", _dotNetRef);
            
            // Start game loop at ~60 FPS
            _cts = new CancellationTokenSource();
            _gameLoop = new PeriodicTimer(TimeSpan.FromMilliseconds(16));
            
            _ = Task.Run(GameLoopAsync);
        }
        catch (Exception ex)
        {
            _loadingMessage = $"Error: {ex.Message}";
            StateHasChanged();
        }
    }
    
    private async Task GameLoopAsync()
    {
        try
        {
            while (await _gameLoop!.WaitForNextTickAsync(_cts!.Token))
            {
                await _emulator!.RunFrameAsync();
            }
        }
        catch (OperationCanceledException)
        {
            // Expected on dispose
        }
    }
    
    private void OnKeyDown(KeyboardEventArgs e)
    {
        _emulator?.KeyDown(e.Key);
    }
    
    private void OnKeyUp(KeyboardEventArgs e)
    {
        _emulator?.KeyUp(e.Key);
    }
    
    private void AcknowledgeSoundWarning()
    {
        _soundWarningAcknowledged?.TrySetResult();
    }
    
    [JSInvokable]
    public void OnTouchKeyDown(string key)
    {
        _emulator?.KeyDown(key);
    }
    
    [JSInvokable]
    public void OnTouchKeyUp(string key)
    {
        _emulator?.KeyUp(key);
    }
    
    public ValueTask DisposeAsync()
    {
        _cts?.Cancel();
        _gameLoop?.Dispose();
        _cts?.Dispose();
        _dotNetRef?.Dispose();
        return ValueTask.CompletedTask;
    }
}
